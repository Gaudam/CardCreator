<!DOCTYPE html>
<html lang="en" id="html-root"> <!-- Added ID for dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Card Creator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIX: Added Tailwind config to enable 'class' dark mode strategy -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the card */
        body {
            font-family: 'Inter', sans-serif;
            /* background-color: #f0f2f5; */ /* Handled by Tailwind */
        }

        /* Dark mode toggle styles */
        .toggle-checkbox:checked {
            @apply: bg-indigo-600;
            right: 0;
        }
        .toggle-checkbox:checked + .toggle-label {
            @apply: bg-indigo-600;
        }
        .toggle-checkbox:checked + .toggle-label .toggle-ball {
            @apply: translate-x-full;
        }

        /* Using a specific font for the card name/HP */
        .font-card-title {
            font-family: 'Luckiest Guy', cursive;
            text-shadow: 1px 1px 3px #000, -1px -1px 3px #000, 1px -1px 3px #000, -1px 1px 3px #000; /* Stronger consolidated shadow */
            font-size: 1.6rem; /* Base size for main title */
            color: white; /* Default to white for these elements */
        }
        
        /* Style for the new main name */
        .card-main-name-container {
            position: absolute;
            top: 30px; /* Adjusted higher */
            left: 14px;
            right: 14px;
            z-index: 2;
        }

        /* Style for creature type - now uses font-card-title but smaller */
        .font-creature-type {
            font-family: 'Luckiest Guy', cursive;
            text-shadow: 1px 1px 3px #000, -1px -1px 3px #000, 1px -1px 3px #000, -1px 1px 3px #000;
            font-size: 1.1rem; /* Smaller than main name */
            color: white;
            line-height: 1; /* Ensure no extra line height */
        }
        
        /* Base card dimensions - now full-art by default */
        .card {
            width: 100%;
            max-width: 380px; /* Max width for better visibility on desktop */
            aspect-ratio: 63 / 88; /* Official TCG card ratio (close to 2.5/3.5) */
            border: 12px solid #f9d71c; /* Yellow border */
            border-radius: 18px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #e0e0e0; /* Default colorless background */
            position: relative; /* Needed for absolute positioning of full art image */
            justify-content: flex-end; /* PUSH ALL CONTENT TO THE BOTTOM */
            padding-bottom: 30px; /* Reduced padding to move text down */
        }

        /* Card Header */
        .card-header {
            padding: 0 14px 8px 14px; /* Set top padding to 0 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: absolute; /* Position over the image */
            top: 6px; /* Adjusted higher */
            left: 0;
            right: 0;
            z-index: 2; /* Ensure header content is above the image */
            height: 38px; /* Fixed height to control spacing */
        }

        /* New element for the top gradient overlay */
        .card-top-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 90px; /* Increased height for a darker, more spread top gradient */
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0)); /* Darker gradient */
            z-index: 1; /* Below header content but above image */
            pointer-events: none; /* Allow clicks to pass through */
        }
        
        /* New element for the vignette overlay */
        .card-vignette-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Start with it hidden */
            display: none;
            /* Rectangular vignette, pushed to the borders */
            background: linear-gradient(to bottom, 
                rgba(0,0,0,0.7) 0%, 
                rgba(0,0,0,0.1) 30%, 
                rgba(0,0,0,0) 70%, 
                rgba(0,0,0,0.1) 90%, 
                rgba(0,0,0,0.7) 100% 
            ),
            linear-gradient(to right,
                rgba(0,0,0,0.7) 0%, 
                rgba(0,0,0,0.1) 30%, 
                rgba(0,0,0,0) 50%, 
                rgba(0,0,0,0.1) 70%, 
                rgba(0,0,0,0.7) 100% 
            );
            z-index: 1;
            pointer-events: none;
        }

        #card-name {
            /* Styles are handled by .font-card-title */
        }

        #card-creature-type {
             /* Styles handled by .font-creature-type */
        }
        
        #card-hp-container, #card-ac-container {
            display: flex;
            align-items: baseline; /* Align numbers and labels nicely */
            line-height: 1;
        }

        #card-hp-container .font-card-title, #card-ac-container .font-card-title {
            font-size: 1.3rem; /* Slightly smaller for AC/HP numbers */
            margin-left: 2px;
        }
        #card-hp-container .font-creature-type, #card-ac-container .font-creature-type {
            font-size: 1.5rem; /* Adjusted bigger for AC/HP labels */
            margin-right: 2px;
            font-weight: 400; /* Labels can be less bold */
        }
        
        #card-energy-icon {
            font-size: 1.8rem; /* Slightly smaller */
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.5));
        }

        /* Card Image Area (for standard layout) */
        .card-image-area {
            position: absolute; /* Take over the entire card area */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0; /* Remove margins */
            border: none; /* Remove borders */
            aspect-ratio: unset; /* Let height be controlled by card height */
            z-index: 0; /* Push to the very back */
            display: flex; /* Use flex for placeholder */
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 600;
            overflow: hidden;
            background: #a0a0a0; /* Placeholder background */
            /* Image styling is now done with background-image */
            background-size: 100%;
            background-position: 50% 50%;
            background-repeat: no-repeat;
        }

        .card-image-area img {
            /* We no longer use an <img> tag, handled by background-image */
            display: none;
        }
        
        /* Flavor text / stats bar */
        .card-stats-bar {
            background: none; 
            border-top: none;
            border-bottom: none; 
            margin: 2px 14px 0 14px; /* Uses same L/R margin as footer */
            padding: 0; 
            position: relative; 
            z-index: 2;
            color: white;
            text-shadow: 1px 1px 2px #000, 0 0 5px #000;
            font-size: 0.8rem; 
            font-style: italic;
            text-align: left; /* CHANGED from center */
        }

        /* Attacks Section */
        .card-attacks {
            flex-grow: 0;
            background: none;
            border: none; 
            margin: 18px 14px 0 14px; /* Uses same L/R margin as footer */
            padding: 0; 
            position: relative; 
            z-index: 2;
            color: white; 
            text-shadow: 1px 1px 2px #000; 
        }
        
        .attack {
            margin-bottom: 8px;
        }

        .attack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .attack-cost {
            font-size: 1.75rem;
            letter-spacing: -2px;
            filter: drop-shadow(0 0 3px rgba(0,0,0,1)); /* Stronger black shadow for icons */
            padding-top: 0; /* Align with text */
            flex-shrink: 0; /* Don't let it shrink */
            /* min-width: 40px; */ /* REMOVED */
            /* text-align: left; */ /* REMOVED */
        }
        
        .attack-name {
            font-weight: 700;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px #000, 0 0 5px #000; /* Stronger black shadow */
        }
        
        .attack-damage {
            font-weight: 700;
            font-size: 1.25rem;
            text-shadow: 1px 1px 2px #000, 0 0 5px #000; /* Stronger black shadow */
        }

        .attack-description {
            font-size: 0.9rem;
        }
        
        .attack-divider {
            border-top: 1px solid rgba(255,255,255,0.3); /* Lighter divider for full art */
            margin: 6px 0;
        }

        .ability-badge {
            font-family: 'Luckiest Guy', cursive;
            font-size: 0.9rem;
            color: #f7b731; /* Changed to a gold color */
            text-shadow: 1px 1px 1px #000; /* Stronger black shadow */
            margin-right: 8px;
        }

        /* NEW CSS for alignment */
        .attack-layout {
            display: flex;
            align-items: flex-start; /* Align top */
            gap: 8px; /* Space between cost and text */
        }
        .attack-details {
            flex-grow: 1; /* Take remaining space */
        }
        
        /* Footer (Weakness/Resistance/Retreat) */
        .card-wrr-bar {
            display: none; /* REMOVED: Hide in full-art mode */
        }
        
        .wrr-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .wrr-item span:first-child {
            font-size: 0.7rem;
            font-weight: 400;
            color: white; /* Ensure label is white */
            text-shadow: 1px 1px 2px #000; /* Add shadow */
        }

        /* Footer */
        .card-footer {
            font-size: 0.7rem;
            padding: 5px 14px 10px 14px; /* Adjusted padding to create a small gap */
            font-weight: 600;
            position: absolute; /* Position absolutely at the bottom */
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 2;
            background: none; 
            color: white; 
            text-shadow: 1px 1px 2px #000, -1px -1px 2px #000; 
            display: flex; /* Use flexbox for layout */
            justify-content: space-between; /* Space out the items */
            align-items: flex-end; /* Align items to the bottom of the footer */
        }
        
        .card-footer-item {
            /* Styles for individual items in the footer */
            line-height: 1.2; /* Adjust line height for better spacing */
        }

        /* Dynamic Backgrounds (Header Fallback) */
        .type-colorless { background: linear-gradient(135deg, #d4d4d4, #a0a0a0); }
        .type-fire { background: linear-gradient(135deg, #FF9D55, #EF5350); }
        .type-water { background: linear-gradient(135deg, #76BDFE, #42A5F5); }
        .type-grass { background: linear-gradient(135deg, #9CCC65, #7CB342); }
        .type-electric { background: linear-gradient(135deg, #FFD740, #FBC02D); }
        .type-psychic { background: linear-gradient(135deg, #BA68C8, #AB47BC); }
        .type-fighting { background: linear-gradient(135deg, #D4A373, #C68642); }
        .type-darkness { background: linear-gradient(135deg, #757575, #545454); }
        .type-metal { background: linear-gradient(135deg, #B0BEC5, #90A4AE); }
        .type-fairy { background: linear-gradient(135deg, #F48FB1, #E91E63); }
        .type-dragon { background: linear-gradient(135deg, #8E2DE2, #4A00E0); }
        /* NEW TYPES */
        .type-god { background: linear-gradient(135deg, #FFD700, #F0E68C); }
        .type-time { background: linear-gradient(135deg, #00BFFF, #87CEEB); }
        .type-space { background: linear-gradient(135deg, #483D8B, #000000); }
        .type-anti-god-magic { background: linear-gradient(135deg, #FF1493, #8B0000); }
        .type-necromancy { background: linear-gradient(135deg, #6A0DAD, #4B0082); }
        .type-cold { background: linear-gradient(135deg, #B0E0E6, #ADD8E6); }
        .type-poison { background: linear-gradient(135deg, #9ACD32, #6B8E23); }
        .type-death { background: linear-gradient(135deg, #2F4F4F, #000000); }
        .type-life { background: linear-gradient(135deg, #90EE90, #32CD32); }
        .type-holy { background: linear-gradient(135deg, #FFFACD, #FFFFE0); }
        .type-illusion { background: linear-gradient(135deg, #DA70D6, #9932CC); }
        .type-machine { background: linear-gradient(135deg, #808080, #A9A9A9); }

        /* Loading Spinner */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #333; /* Dark text for light modal */
        }
        .dark .modal-content {
            background: #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
        }
        .dark .modal-content th {
            color: #f3f4f6; /* gray-100 */
        }


    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-4 md:p-8 transition-colors duration-200">

    <div class="max-w-7xl mx-auto">
        <!-- MODIFIED: Header layout for better mobile responsiveness -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-8 gap-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-center sm:text-left text-gray-800 dark:text-gray-100">Custom Card Creator</h1>
            
            <!-- Dark Mode Toggle -->
            <!-- MODIFIED: Removed absolute positioning, added responsive centering -->
            <div class="flex items-center space-x-2 justify-center sm:justify-end">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="dark-mode-toggle" id="dark-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="dark-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- FORM CONTROLS -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-200">Card Details</h2>
                <form id="card-form" class="space-y-4">

                    <!-- Basic Info -->
                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Basic Info</legend>
                        <!-- MODIFIED: Changed sm:grid-cols-2 to md:grid-cols-2 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="input-creature-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Creature Type</label>
                                <input type="text" id="input-creature-type" value="Robot" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="input-card-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Card Name</label>
                                <input type="text" id="input-card-name" value="Gemini" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="input-card-hp" class="block text-sm font-medium text-gray-700 dark:text-gray-300">HP</label>
                                <input type="number" id="input-card-hp" value="120" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="input-card-ac" class="block text-sm font-medium text-gray-700 dark:text-gray-300">AC</label>
                                <input type="number" id="input-card-ac" value="15" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="col-span-2 sm:col-span-1">
                                <label for="input-card-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Energy Type</label>
                                <select id="input-card-type" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="colorless" selected>Colorless</option>
                                    <option value="fire">Fire</option>
                                    <option value="water">Water</option>
                                    <option value="grass">Grass</option>
                                    <option value="electric">Electric</option>
                                    <option value="psychic">Psychic</option>
                                    <option value="fighting">Fighting</option>
                                    <option value="darkness">Darkness</option>
                                    <option value="metal">Metal</option>
                                    <option value="fairy">Fairy</option>
                                    <option value="dragon">Dragon</option>
                                    <option value="god">God</option>
                                    <option value="time">Time</option>
                                    <option value="space">Space</option>
                                    <option value="anti-god-magic">Anti God Magic</option>
                                    <option value="necromancy">Necromancy</option>
                                    <option value="cold">Cold</option>
                                    <option value="poison">Poison</option>
                                    <option value="death">Death</option>
                                    <option value="life">Life</option>
                                    <option value="holy">Holy</option>
                                    <option value="illusion">Illusion</option>
                                    <option value="machine">Machine</option>
                                </select>
                            </div>
                            <div class="col-span-1">
                                <label for="input-border-color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Border Color</label>
                                <input type="color" id="input-border-color" value="#f9d71c" class="mt-1 block w-full h-10 rounded-md border-gray-300 dark:border-gray-600 shadow-sm">
                            </div>
                            <div class="col-span-2 sm:col-span-1">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Energy Legend</label>
                                <button type="button" id="view-energy-btn" class="mt-1 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600">
                                    View Energy Types
                                </button>
                            </div>
                            <div class="col-span-2">
                                <label for="input-overlay-color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Overlay Color (for gradients)</label>
                                <input type="color" id="input-overlay-color" value="#000000" class="mt-1 block w-full h-10 rounded-md border-gray-300 dark:border-gray-600 shadow-sm">
                            </div>
                            <div class="col-span-2 flex items-center">
                                <input type="checkbox" id="input-vignette-toggle" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                                <label for="input-vignette-toggle" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Apply Rectangular Vignette</label>
                            </div>
                            <div class="col-span-1">
                                <label for="input-set-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Set Name</label>
                                <input type="text" id="input-set-name" value="Galactic Genesis" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="col-span-1">
                                <label for="input-card-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Card Number (e.g., 15/150)</label>
                                <input type="text" id="input-card-number" value="1/100" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Card Image -->
                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Card Image</legend>
                        <div>
                            <label for="input-image-upload" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Upload Image</label>
                            <input type="file" id="input-image-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 dark:file:bg-indigo-900 file:text-indigo-700 dark:file:text-indigo-300 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-800">
                            <button type="button" id="clear-upload-btn" class="mt-2 w-full text-sm text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300">Clear Upload</button>
                        </div>
                        <!-- Image Generation Removed -->
                        
                        <!-- NEW Image Controls -->
                        <div id="image-controls" class="mt-4 border-t dark:border-gray-600 pt-4 space-y-2 hidden">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Image Controls</h4>
                            <div>
                                <label for="image-zoom" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Zoom (<span id="zoom-value">100</span>%)</label>

                                <input type="range" id="image-zoom" min="100" max="3000" value="100" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="image-pos-x" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Horizontal (<span id="pos-x-value">50</span>%)</label>
                                <input type="range" id="image-pos-x" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="image-pos-y" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Vertical (<span id="pos-y-value">50</span>%)</label>
                                <input type="range" id="image-pos-y" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <button type="button" id="reset-image-btn" class="mt-2 w-full text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Reset Position</button>
                        </div>
                    </fieldset>
                    
                    <!-- Flavor Text -->
                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Flavor Text</legend>
                         <div>
                            <textarea id="input-flavor-text" rows="2" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">It constantly processes information from across the web to answer any question.</textarea>
                        </div>
                    </fieldset>

                    <!-- Attacks & Abilities -->
                    <fieldset id="attacks-manager" class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Attacks & Abilities</legend>
                        <div id="attack-forms-container" class="space-y-4">
                            <!-- Dynamic forms go here -->
                        </div>
                        <button type="button" id="add-attack-btn" class="mt-4 w-full inline-flex justify-center rounded-md border border-dashed border-gray-400 dark:border-gray-500 py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700">
                            + Add Attack / Ability
                        </button>
                    </fieldset>
                    
                    <!-- Illustrator -->
                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Creator</legend>
                        <div class="mt-0">
                            <label for="input-illustrator" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Creator Name</label>
                            <input type="text" id="input-illustrator" value="AI Generated" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                        </div>
                    </fieldset>

                    <!-- NEW Import/Export -->
                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Import/Export Card</legend>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Save your card data as a .json file to edit later or on another device.</p>
                        <!-- MODIFIED: Changed sm:grid-cols-2 to md:grid-cols-2 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button type="button" id="export-data-btn" class="w-full inline-flex justify-center rounded-md border border-transparent bg-gray-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:ring-offset-gray-800">
                                Export Data (.json)
                            </button>
                            <div>
                                <label for="import-data-btn" class="w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
                                    Import Data (.json)
                                </label>
                                <input type="file" id="import-data-btn" accept=".json,application/json" class="hidden">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Download Buttons -->
                    <button type="button" id="download-btn" class="mt-4 w-full inline-flex justify-center rounded-md border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:ring-offset-gray-800">
                        Download Card (Web PNG)
                    </button>
                    <!-- NEW PRINT BUTTON -->
                    <button type="button" id="download-print-btn" class="mt-2 w-full inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:ring-offset-gray-800">
                        Download for Print (Poker 822x1122px)
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Use the 'Print' button for services that require a 36px bleed, as specified in the PDF.</p>

                </form>
            </div>

            <!-- CARD PREVIEW -->
            <div class="flex flex-col items-center">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-200 md:hidden">Card Preview</h2>
                
                <!-- The Card -->
                <div id="card-preview" class="card type-colorless">
                    
                    <!-- Top Gradient -->
                    <div id="card-top-overlay" class="card-top-overlay"></div>
                    <!-- Vignette -->
                    <div id="card-vignette-overlay" class="card-vignette-overlay"></div>
                    
                    <!-- Header (Creature Type, HP, AC, Energy Icon) -->
                    <div class="card-header">
                        <h3 id="card-creature-type" class="font-creature-type">Robot</h3>
                        <div class="flex items-center space-x-3">
                            <div id="card-ac-container" class="flex items-center space-x-1">
                                <span class="font-creature-type">AC</span>
                                <span id="card-ac" class="font-card-title ml-1">15</span>
                            </div>
                            <div id="card-hp-container" class="flex items-center space-x-1">
                                <span class="font-creature-type">HP</span>
                                <span id="card-hp" class="font-card-title ml-1">120</span>
                            </div>
                            <span id="card-energy-icon">âšª</span>
                        </div>
                    </div>
                    
                    <!-- Main Name Container -->
                    <div class="card-main-name-container">
                        <h2 id="card-name" class="font-card-title">Gemini</h2>
                    </div>

                    <!-- Image Area -->
                    <div class="card-image-area" id="card-image-area">
                        <div class="text-center p-4">
                            Upload an image to create your card's art.
                        </div>
                    </div>
                    
                    <!-- Attacks (at bottom) -->
                    <div class="card-attacks" id="card-attacks-output">
                        <!-- Dynamic content -->
                    </div>

                    <!-- Flavor Text (at bottom) -->
                    <div class="card-stats-bar">
                        <span id="card-flavor-text">It constantly processes information from across the web to answer any question.</span>
                    </div>

                    <!-- WRR Bar (hidden) -->
                    <div id="card-wrr-bar" class="card-wrr-bar">
                        <!-- Content removed -->
                    </div>
                    
                    <!-- Footer (at bottom) -->
                    <div class="card-footer">
                        <div class="card-footer-item">
                            Creator: <span id="card-illustrator">AI Generated</span>
                        </div>
                        <div class="card-footer-item text-right">
                            <span id="card-set-name">Galactic Genesis</span>
                            <span id="card-number" class="ml-2">1/100</span> 
                            <!-- Removed <br> -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Energy Modal -->
    <div id="energy-modal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Energy Type Legend</h3>
                <button type="button" id="close-modal-btn" class="text-2xl font-bold">&times;</button>
            </div>
            <p class="mb-4">Use these codes in the 'Cost' field.</p>
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-gray-100 dark:bg-gray-800">
                        <th class="p-2">Code (Key)</th>
                        <th class="p-2">Icon</th>
                        <th class="p-2">Type</th>
                    </tr>
                </thead>
                <tbody id="energy-modal-table">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- API Key (Leave as is) ---
        const apiKey = ""; // This will be auto-filled by the environment

        // --- Global State ---
        let uploadedImageUrl = null;
        let attackCounter = 0;

        // --- Element References (Global for helper functions) ---
        let inputs, outputs, buttons, imageControls;

        // --- Energy Maps ---
        const energyIconMap = {
            'C': 'âšª', // Colorless
            'F': 'ðŸ”¥', // Fire
            'W': 'ðŸ’§', // Water
            'G': 'ðŸŒ¿', // Grass
            'L': 'âš¡', // Electric
            'P': 'ðŸ”®', // Psychic
            'H': 'âœŠ', // Fighting
            'D': 'ðŸŒ™', // Darkness
            'M': 'âš™ï¸', // Metal
            'Y': 'âœ¨', // Fairy
            'N': 'ðŸ‰', // Dragon
            // NEW KEYS
            'O': 'ðŸ‘‘', // God (Olympos)
            'T': 'âŒ›', // Time
            'S': 'ðŸŒŒ', // Space
            'A': 'ðŸš«', // Anti God Magic
            'Z': 'ðŸ’€', // Necromancy (Zombie)
            'I': 'â„ï¸', // Cold (Ice)
            'V': 'â˜£ï¸', // Poison (Venom)
            'X': 'â˜ ï¸', // Death
            'E': 'ðŸ’–', // Life (Eros/Heart)
            'K': 'ðŸŒŸ', // Holy (Kadosh)
            'U': 'ðŸŒ€', // Illusion (Unreal)
            'B': 'ðŸ¤–', // Machine (Bot)
        };
        
        const energyTypeMap = {
            'colorless': { name: 'Colorless', icon: 'âšª', class: 'type-colorless' },
            'fire': { name: 'Fire', icon: 'ðŸ”¥', class: 'type-fire' },
            'water': { name: 'Water', icon: 'ðŸ’§', class: 'type-water' },
            'grass': { name: 'Grass', icon: 'ðŸŒ¿', class: 'type-grass' },
            'electric': { name: 'Electric', icon: 'âš¡', class: 'type-electric' },
            'psychic': { name: 'Psychic', icon: 'ðŸ”®', class: 'type-psychic' },
            'fighting': { name: 'Fighting', icon: 'âœŠ', class: 'type-fighting' },
            'darkness': { name: 'Darkness', icon: 'ðŸŒ™', class: 'type-darkness' },
            'metal': { name: 'Metal', icon: 'âš™ï¸', class: 'type-metal' },
            'fairy': { name: 'Fairy', icon: 'âœ¨', class: 'type-fairy' },
            'dragon': { name: 'Dragon', icon: 'ðŸ‰', class: 'type-dragon' },
            // NEW TYPES
            'god': { name: 'God', icon: 'ðŸ‘‘', class: 'type-god' },
            'time': { name: 'Time', icon: 'âŒ›', class: 'type-time' },
            'space': { name: 'Space', icon: 'ðŸŒŒ', class: 'type-space' },
            'anti-god-magic': { name: 'Anti God Magic', icon: 'ðŸš«', class: 'type-anti-god-magic' },
            'necromancy': { name: 'Necromancy', icon: 'ðŸ’€', class: 'type-necromancy' },
            'cold': { name: 'Cold', icon: 'â„ï¸', class: 'type-cold' },
            'poison': { name: 'Poison', icon: 'â˜£ï¸', class: 'type-poison' },
            'death': { name: 'Death', icon: 'â˜ ï¸', class: 'type-death' },
            'life': { name: 'Life', icon: 'ðŸ’–', class: 'type-life' },
            'holy': { name: 'Holy', icon: 'ðŸŒŸ', class: 'type-holy' },
            'illusion': { name: 'Illusion', icon: 'ðŸŒ€', class: 'type-illusion' },
            'machine': { name: 'Machine', icon: 'ðŸ¤–', class: 'type-machine' },
        };

        // --- Utility Functions ---

        /**
         * Parses a cost string (e.g., "PPC") and returns energy icons.
         * @param {string} costString The input string (e.g., "FFC").
         * @returns {string} The HTML string of icons.
         */
        function parseEnergyCost(costString) {
            if (!costString) return '';
            return costString.toUpperCase().split('').map(char => energyIconMap[char] || char).join('');
        }
        
        /**
         * Fetches with exponential backoff.
         */
        /* Fuction fetchWithBackoff removed as it's no longer used */


        // --- Image Generation Function ---
        /* Function generateCardImage removed */
        
        // --- Download Card Function (Standard) ---
        async function downloadCard() {
            const cardElement = document.getElementById('card-preview');
            const downloadBtn = document.getElementById('download-btn');
            
            // FIX: Get overlay elements
            const topOverlay = document.getElementById('card-top-overlay');
            const vignetteOverlay = document.getElementById('card-vignette-overlay');
            
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Preparing...';

            // FIX: Hide overlays before rendering to prevent visual artifacts
            const topOverlayOriginalDisplay = topOverlay.style.display;
            const vignetteOverlayOriginalDisplay = vignetteOverlay.style.display;
            topOverlay.style.display = 'none';
            vignetteOverlay.style.display = 'none';

            try {
                const canvas = await html2canvas(cardElement, {
                    useCORS: true, 
                    scale: 2, // High-res for web
                    backgroundColor: null // Ensure transparency is respected if card background is none
                });

                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'my-custom-card.png';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error("Failed to download card:", err);
            } finally {
                // FIX: Restore overlays
                topOverlay.style.display = topOverlayOriginalDisplay;
                vignetteOverlay.style.display = vignetteOverlayOriginalDisplay;
                
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Download Card (Web PNG)';
            }
        }

        // --- NEW: Download Card for Print ---
        /**
         * Creates a special 822x1122px PNG with a 36px bleed
         * based on the PDF specifications for a "Poker" card.
         * This version composites a scaled UI layer and a full-bleed art layer.
         */
        async function downloadCardForPrint() {
            const cardElement = document.getElementById('card-preview');
            const printBtn = document.getElementById('download-print-btn');
            
            // FIX: Get overlay elements
            const topOverlay = document.getElementById('card-top-overlay');
            const vignetteOverlay = document.getElementById('card-vignette-overlay');
            
            printBtn.disabled = true;
            printBtn.textContent = 'Preparing Print File...';

            // FIX: Hide overlays before rendering to prevent visual artifacts
            const topOverlayOriginalDisplay = topOverlay.style.display;
            const vignetteOverlayOriginalDisplay = vignetteOverlay.style.display;
            topOverlay.style.display = 'none';
            vignetteOverlay.style.display = 'none';
            
            try {
                // 1. Render the UI layer (text, borders, overlays)
                // We render at 2x scale to get sharp text, then downscale
                const uiCanvas = await html2canvas(cardElement, {
                    useCORS: true,
                    scale: 2, 
                    backgroundColor: null // Transparent background
                });

                // --- Restore preview card to normal ---
                topOverlay.style.display = topOverlayOriginalDisplay;
                vignetteOverlay.style.display = vignetteOverlayOriginalDisplay;

                // 2. Create the final 822x1122 print canvas
                const printCanvas = document.createElement('canvas');
                printCanvas.width = 822;
                printCanvas.height = 1122;
                const ctx = printCanvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';

                // 3. FIX: Fill the *entire* canvas with the border color for the bleed
                const borderColor = document.getElementById('input-border-color').value;
                ctx.fillStyle = borderColor;
                ctx.fillRect(0, 0, 822, 1122);

                // 4. Composite the rendered card (uiCanvas) inside the "safe area"
                // The safe area starts at 36, 36 and is 750x1050
                ctx.drawImage(uiCanvas, 36, 36, 750, 1050); 

                // 5. Download the final composited image
                const link = document.createElement('a');
                link.href = printCanvas.toDataURL('image/png');
                link.download = 'my-card-PRINT-READY-822x1122.png';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (err) {
                console.error("Failed to download print-ready card:", err);
            } finally {
                // 8. Clean up
                printBtn.disabled = false;
                printBtn.textContent = 'Download for Print (Poker 822x1122px)';
                // Restore preview card just in case of error
                topOverlay.style.display = topOverlayOriginalDisplay;
                vignetteOverlay.style.display = vignetteOverlayOriginalDisplay;
            }
        }

        // --- START: Data Save/Load Functions ---

        /**
         * Gathers all data from the form into a single object.
         */
        function getCurrentCardData() {
            const inputs = {
                creatureType: document.getElementById('input-creature-type').value,
                cardName: document.getElementById('input-card-name').value,
                cardHp: document.getElementById('input-card-hp').value,
                cardAc: document.getElementById('input-card-ac').value,
                cardType: document.getElementById('input-card-type').value,
                borderColor: document.getElementById('input-border-color').value,
                flavorText: document.getElementById('input-flavor-text').value,
                illustrator: document.getElementById('input-illustrator').value,
                overlayColor: document.getElementById('input-overlay-color').value,
                vignetteToggle: document.getElementById('input-vignette-toggle').checked,
                setName: document.getElementById('input-set-name').value,
                cardNumber: document.getElementById('input-card-number').value,
                /* imagePrompt removed */
            };

            const imageControls = {
                cardImage: document.getElementById('card-image-area').style.backgroundImage,
                imageZoom: document.getElementById('image-zoom').value,
                imagePosX: document.getElementById('image-pos-x').value,
                imagePosY: document.getElementById('image-pos-y').value
            };

            const attacks = [];
            document.querySelectorAll('#attack-forms-container .attack-form').forEach(form => {
                const formInputs = form.querySelectorAll('input, textarea, select');
                attacks.push({
                    type: formInputs[0].value,
                    name: formInputs[1].value,
                    cost: formInputs[2].value,
                    desc: formInputs[3].value,
                    damage: formInputs[4].value
                });
            });

            const theme = {
                darkMode: document.documentElement.classList.contains('dark')
            };

            return { ...inputs, ...imageControls, attacks, theme };
        }

        /**
         * Populates the entire form and preview from a data object.
         */
        function populateForm(data) {
            if (!data) return;

            // Load theme
            if (data.theme?.darkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-mode-toggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('dark-mode-toggle').checked = false;
            }

            // Load simple inputs
            document.getElementById('input-creature-type').value = data.creatureType || 'Robot';
            document.getElementById('input-card-name').value = data.cardName || 'Gemini';
            document.getElementById('input-card-hp').value = data.cardHp ?? '';
            document.getElementById('input-card-ac').value = data.cardAc ?? '';
            document.getElementById('input-card-type').value = data.cardType || 'colorless';
            document.getElementById('input-border-color').value = data.borderColor || '#f9d71c';
            document.getElementById('input-flavor-text').value = data.flavorText || '';
            document.getElementById('input-illustrator').value = data.illustrator || 'AI Generated';
            document.getElementById('input-overlay-color').value = data.overlayColor || '#000000';
            document.getElementById('input-vignette-toggle').checked = data.vignetteToggle || false;
            document.getElementById('input-set-name').value = data.setName || 'Set Name';
            document.getElementById('input-card-number').value = data.cardNumber || '1/100';
            /* imagePrompt removed */

            // Load image
            const imageArea = document.getElementById('card-image-area');
            if (data.cardImage && data.cardImage !== 'none') {
                imageArea.style.backgroundImage = data.cardImage;
                imageArea.innerHTML = ''; // Clear placeholder
                document.getElementById('image-controls').classList.remove('hidden');
                document.getElementById('image-zoom').value = data.imageZoom || 100;
                document.getElementById('image-pos-x').value = data.imagePosX || 50;
                document.getElementById('image-pos-y').value = data.imagePosY || 50;
                uploadedImageUrl = data.cardImage.includes("data:image") ? data.cardImage.match(/url\("?(.+?)"?\)/)[1] : null;
            } else {
                // Clear image
                imageArea.style.backgroundImage = 'none';
                imageArea.innerHTML = `<div class="text-center p-4">Upload an image to create your card's art.</div>`;
                document.getElementById('image-controls').classList.add('hidden');
                uploadedImageUrl = null;
            }


            // Load attacks
            document.getElementById('attack-forms-container').innerHTML = ''; // Clear existing
            if (data.attacks && data.attacks.length > 0) {
                data.attacks.forEach(attackData => createAttackForm(attackData));
            }

            // --- Trigger all update functions to sync preview ---
            // This is critical
            document.getElementById('input-creature-type').dispatchEvent(new Event('input'));
            document.getElementById('input-card-name').dispatchEvent(new Event('input'));
            document.getElementById('input-card-hp').dispatchEvent(new Event('input'));
            document.getElementById('input-card-ac').dispatchEvent(new Event('input'));
            document.getElementById('input-card-type').dispatchEvent(new Event('change'));
            document.getElementById('input-border-color').dispatchEvent(new Event('input'));
            document.getElementById('input-flavor-text').dispatchEvent(new Event('input'));
            document.getElementById('input-illustrator').dispatchEvent(new Event('input'));
            document.getElementById('input-overlay-color').dispatchEvent(new Event('input'));
            document.getElementById('input-vignette-toggle').dispatchEvent(new Event('change'));
            document.getElementById('input-set-name').dispatchEvent(new Event('input'));
            document.getElementById('input-card-number').dispatchEvent(new Event('input'));
            
            // FIX: This function is defined *later* in the DOMContentLoaded event,
            // but it needs to be accessible *here*.
            // We moved it outside the DOMContentLoaded listener.
            updateImageTransform(); // Update zoom/pos
            updateCardAttacks(); // Update attacks
        }

        /**
         * Saves the current card data to localStorage.
         */
        function saveDataToLocalStorage() {
            try {
                const data = getCurrentCardData();
                localStorage.setItem('customCardData', JSON.stringify(data));
            } catch (error) {
                console.error("Failed to save data to localStorage:", error);
            }
        }

        /**
         * Loads card data from localStorage on page load.
         */
        function loadDataFromLocalStorage() {
            const dataString = localStorage.getItem('customCardData');
            if (dataString) {
                try {
                    const data = JSON.parse(dataString);
                    populateForm(data);
                    return true; // Data was loaded
                } catch (error) {
                    console.error("Failed to parse data from localStorage:", error);
                    localStorage.removeItem('customCardData'); // Clear bad data
                    return false;
                }
            }
            return false; // No data found
        }

        /**
         * Exports the current card data as a .json file.
         */
        function exportCardData() {
            const data = getCurrentCardData();
            const jsonString = JSON.stringify(data, null, 2); // Pretty-print JSON
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${data.cardName || 'custom-card'}-data.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * Handles the file upload for importing card data.
         */
        function importCardData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    populateForm(data);
                    saveDataToLocalStorage(); // Save imported data
                } catch (error) {
                    console.error("Failed to import card data:", error);
                    // You could show a user-facing error message here
                }
            };
            reader.readAsText(file);
            
            // Clear the file input so the same file can be re-uploaded
            event.target.value = null;
        }

        // --- END: Data Save/Load Functions ---


        // --- Dynamic Attack Functions ---

        /**
         * Creates a new attack form and adds it to the DOM.
         */
        function createAttackForm(defaultValues = {}) {
            attackCounter++;
            const id = attackCounter;
            
            const {
                type = 'attack',
                cost = 'CC',
                name = 'New Attack',
                desc = 'Attack description.',
                damage = '10'
            } = defaultValues;

            const formContainer = document.getElementById('attack-forms-container');
            const attackForm = document.createElement('div');
            attackForm.className = 'attack-form border dark:border-gray-600 p-3 rounded-md bg-gray-50 dark:bg-gray-700 space-y-2 relative';
            attackForm.dataset.id = id;

            attackForm.innerHTML = `
                <button type="button" class="delete-attack-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">&times;</button>
                
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                        <select class="attack-type-select mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                            <option value="attack" ${type === 'attack' ? 'selected' : ''}>Attack</option>
                            <option value="ability" ${type === 'ability' ? 'selected' : ''}>Ability</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                        <input type="text" value="${name}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Cost (e.g., CC)</label>
                    <input type="text" value="${cost}" class="attack-cost-input mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea rows="2" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">${desc}</textarea>
                </div>
                <div class="attack-damage-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Damage</label>
                    <input type="text" value="${damage}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                </div>
            `;

            formContainer.appendChild(attackForm);

            // Add event listeners
            attackForm.querySelector('.delete-attack-btn').addEventListener('click', () => {
                attackForm.remove();
                updateCardAttacks();
                saveDataToLocalStorage(); // Save change
            });
            
            const typeSelect = attackForm.querySelector('.attack-type-select');
            const damageField = attackForm.querySelector('.attack-damage-field');
            const costInput = attackForm.querySelector('.attack-cost-input');

            // Toggle fields based on type
            const toggleType = () => {
                if (typeSelect.value === 'ability') {
                    damageField.style.display = 'none';
                    costInput.style.display = 'none'; // Abilities often have no cost
                } else {
                    damageField.style.display = 'block';
                    costInput.style.display = 'block';
                }
            };
            typeSelect.addEventListener('change', () => {
                toggleType();
                updateCardAttacks();
                saveDataToLocalStorage(); // Save change
            });
            
            // Add listeners to all inputs to update preview
            attackForm.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', () => {
                    updateCardAttacks();
                    saveDataToLocalStorage(); // Save change
                });
            });

            toggleType(); // Initial check
        }

        /**
         * Reads all attack forms and updates the card preview.
         * THIS FUNCTION IS UPDATED FOR ALIGNMENT.
         */
        function updateCardAttacks() {
            const forms = document.querySelectorAll('#attack-forms-container .attack-form');
            const outputContainer = document.getElementById('card-attacks-output');
            if (!outputContainer) return; // Safety check
            outputContainer.innerHTML = '';

            forms.forEach((form, index) => {
                const inputs = form.querySelectorAll('input, textarea, select');
                const type = inputs[0].value;
                const name = inputs[1].value;
                const cost = inputs[2].value;
                const desc = inputs[3].value;
                const damage = inputs[4].value;

                const attackEl = document.createElement('div');
                attackEl.className = 'attack';

                // We build the HTML differently now
                if (type === 'attack') {
                    const costHTML = parseEnergyCost(cost);
                    // Only add the cost div if there is a cost
                    attackEl.innerHTML = `
                        <div class="attack-layout">
                            ${costHTML ? `<div class="attack-cost">${costHTML}</div>` : ''}
                            <!-- THIS LINE IS NOW FIXED -->
                            <div class="attack-details"> 
                                <div class="attack-header">
                                    <span class="attack-name">${name}</span>
                                    <span class="attack-damage">${damage}</span>
                                </div>
                                <p class="attack-description">
                                    ${desc.replace(/\n/g, '<br>')}
                                </p>
                            </div>
                        </div>
                    `;
                } else { // Ability
                    // Abilities render directly, no layout wrapper
                    attackEl.innerHTML = `
                        <div class="attack-details">
                            <div class="attack-header">
                                <div class="flex items-center">
                                    <span class="ability-badge">Ability</span>
                                    <span class="attack-name">${name}</span>
                                </div>
                            </div>
                            <p class="attack-description">
                                ${desc.replace(/\n/g, '<br>')}
                            </p>
                        </div>
                    `;
                }
                
                outputContainer.appendChild(attackEl);

                // Add divider if not the last attack
                if (index < forms.length - 1) {
                    const hr = document.createElement('hr');
                    hr.className = 'attack-divider';
                    outputContainer.appendChild(hr);
                }
            });
        }

        // --- Image Transform Function (Moved to global scope) ---
        function updateImageTransform() {
            if (!inputs.imageZoom || !inputs.imagePosX || !inputs.imagePosY || !outputs.imageArea || !outputs.zoomValue || !outputs.posXValue || !outputs.posYValue) return; // <-- ADDED SAFETY CHECK
            const zoom = inputs.imageZoom.value;
            const posX = inputs.imagePosX.value;
            const posY = inputs.imagePosY.value;

            outputs.imageArea.style.backgroundSize = `${zoom}%`;
            outputs.imageArea.style.backgroundPosition = `${posX}% ${posY}%`;
            
            // Update slider value displays
            outputs.zoomValue.textContent = zoom;
            outputs.posXValue.textContent = posX;
            outputs.posYValue.textContent = posY;
        }
        
        // --- Main Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Get Elements ---
            inputs = {
                creatureType: document.getElementById('input-creature-type'), 
                cardName: document.getElementById('input-card-name'),
                cardHp: document.getElementById('input-card-hp'),
                cardAc: document.getElementById('input-card-ac'),
                cardType: document.getElementById('input-card-type'),
                borderColor: document.getElementById('input-border-color'),
                imageUpload: document.getElementById('input-image-upload'),
                flavorText: document.getElementById('input-flavor-text'),
                illustrator: document.getElementById('input-illustrator'),
                overlayColor: document.getElementById('input-overlay-color'), 
                vignetteToggle: document.getElementById('input-vignette-toggle'), 
                setName: document.getElementById('input-set-name'), 
                cardNumber: document.getElementById('input-card-number'), 
                // Image controls
                imageZoom: document.getElementById('image-zoom'),
                imagePosX: document.getElementById('image-pos-x'),
                imagePosY: document.getElementById('image-pos-y'),
            };

            outputs = {
                card: document.getElementById('card-preview'),
                creatureType: document.getElementById('card-creature-type'), 
                cardName: document.getElementById('card-name'),
                cardHp: document.getElementById('card-hp'),
                cardHpContainer: document.getElementById('card-hp-container'), // ADDED
                cardAc: document.getElementById('card-ac'),
                cardAcContainer: document.getElementById('card-ac-container'), // ADDED
                cardEnergyIcon: document.getElementById('card-energy-icon'),
                imageArea: document.getElementById('card-image-area'),
                flavorText: document.getElementById('card-flavor-text'),
                attacks: document.getElementById('card-attacks-output'),
                illustrator: document.getElementById('card-illustrator'),
                wrrBar: document.getElementById('card-wrr-bar'), 
                cardTopOverlay: document.getElementById('card-top-overlay'), 
                cardVignetteOverlay: document.getElementById('card-vignette-overlay'), 
                setName: document.getElementById('card-set-name'), 
                cardNumber: document.getElementById('card-number'), 
                // Image control value displays
                zoomValue: document.getElementById('zoom-value'),
                posXValue: document.getElementById('pos-x-value'),
                posYValue: document.getElementById('pos-y-value'),
            };

            buttons = {
                /* generateImage removed */
                downloadCard: document.getElementById('download-btn'),
                downloadPrint: document.getElementById('download-print-btn'), // NEW
                clearUpload: document.getElementById('clear-upload-btn'),
                addAttack: document.getElementById('add-attack-btn'),
                viewEnergy: document.getElementById('view-energy-btn'),
                closeModal: document.getElementById('close-modal-btn'),
                resetImage: document.getElementById('reset-image-btn'),
                darkModeToggle: document.getElementById('dark-mode-toggle'), // NEW
                exportData: document.getElementById('export-data-btn'), // NEW
                importData: document.getElementById('import-data-btn') // NEW
            };
            
            imageControls = document.getElementById('image-controls');

            // --- Helper to bind text content ---
            function bindText(inputEl, outputEl, parserFn = null) {
                if (!inputEl || !outputEl) { // <-- ADDED SAFETY CHECK
                    console.warn("bindText: Missing input or output element.", inputEl, outputEl);
                    return;
                }
                const update = () => {
                    outputEl[parserFn ? 'innerHTML' : 'textContent'] = parserFn 
                        ? parserFn(inputEl.value) 
                        : inputEl.value;
                };
                inputEl.addEventListener('input', update);
                update(); // Initial sync
            }
            
            // --- Bind Simple Text Fields ---
            bindText(inputs.creatureType, outputs.creatureType); 
            bindText(inputs.cardName, outputs.cardName);
            // REMOVED bindText for HP and AC
            bindText(inputs.flavorText, outputs.flavorText);
            bindText(inputs.illustrator, outputs.illustrator);
            bindText(inputs.setName, outputs.setName); 
            bindText(inputs.cardNumber, outputs.cardNumber); 
            
            // --- Bind HP and AC with visibility toggle ---
            const updateHp = () => {
                if (!inputs.cardHp || !outputs.cardHp || !outputs.cardHpContainer) return; // <-- ADDED SAFETY CHECK
                const value = inputs.cardHp.value;
                outputs.cardHp.textContent = value;
                outputs.cardHpContainer.style.display = value ? 'flex' : 'none';
            };
            if(inputs.cardHp) inputs.cardHp.addEventListener('input', updateHp);
            updateHp(); // Initial sync

            const updateAc = () => {
                if (!inputs.cardAc || !outputs.cardAc || !outputs.cardAcContainer) return; // <-- ADDED SAFETY CHECK
                const value = inputs.cardAc.value;
                outputs.cardAc.textContent = value;
                outputs.cardAcContainer.style.display = value ? 'flex' : 'none';
            };
            if(inputs.cardAc) inputs.cardAc.addEventListener('input', updateAc);
            updateAc(); // Initial sync
            
            // --- Bind Card Type ---
            if (inputs.cardType) { // <-- ADDED SAFETY CHECK
                inputs.cardType.addEventListener('change', () => {
                    const type = inputs.cardType.value;
                    const typeData = energyTypeMap[type] || energyTypeMap['colorless'];
                    if (outputs.cardEnergyIcon) outputs.cardEnergyIcon.textContent = typeData.icon;
                    Object.values(energyTypeMap).forEach(data => {
                        if (outputs.card) outputs.card.classList.remove(data.class);
                    });
                    if (outputs.card) outputs.card.classList.add(typeData.class);
                });
                inputs.cardType.dispatchEvent(new Event('change'));
            }

            // --- Bind Border Color ---
            if (inputs.borderColor && outputs.card) { // <-- ADDED SAFETY CHECK
                inputs.borderColor.addEventListener('input', () => {
                    outputs.card.style.borderColor = inputs.borderColor.value;
                });
                inputs.borderColor.dispatchEvent(new Event('input')); // Initial sync
            }

            // --- Bind Overlay Color ---
            function hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            if (inputs.overlayColor) { // <-- ADDED SAFETY CHECK
                inputs.overlayColor.addEventListener('input', () => {
                    const color = inputs.overlayColor.value;
                    if (outputs.cardTopOverlay) outputs.cardTopOverlay.style.background = `linear-gradient(to bottom, ${hexToRgba(color, 0.8)}, ${hexToRgba(color, 0)})`;
                    
                    // Updated: Rectangular vignette using overlay color
                    if (outputs.cardVignetteOverlay) outputs.cardVignetteOverlay.style.background = `
                        linear-gradient(to bottom, 
                            ${hexToRgba(color, 0.7)} 0%, 
                            ${hexToRgba(color, 0.1)} 30%, 
                            ${hexToRgba(color, 0)} 70%, 
                            ${hexToRgba(color, 0.1)} 90%, 
                            ${hexToRgba(color, 0.7)} 100%
                        ),
                        linear-gradient(to right,
                            ${hexToRgba(color, 0.7)} 0%, 
                            ${hexToRgba(color, 0.1)} 30%, 
                            ${hexToRgba(color, 0)} 50%, 
                            ${hexToRgba(color, 0.1)} 70%, 
                            ${hexToRgba(color, 0.7)} 100%
                        )
                    `;
                });
                inputs.overlayColor.dispatchEvent(new Event('input')); // Initial sync
            }

            // --- Bind Vignette Toggle ---
            if (inputs.vignetteToggle) { // <-- ADDED SAFETY CHECK
                inputs.vignetteToggle.addEventListener('change', () => {
                    if (inputs.vignetteToggle.checked) {
                        if (outputs.cardVignetteOverlay) outputs.cardVignetteOverlay.style.display = 'block';
                        if (outputs.cardTopOverlay) outputs.cardTopOverlay.style.display = 'none';
                    } else {
                        if (outputs.cardVignetteOverlay) outputs.cardVignetteOverlay.style.display = 'none';
                        if (outputs.cardTopOverlay) outputs.cardTopOverlay.style.display = 'block';
                    }
                });
                inputs.vignetteToggle.dispatchEvent(new Event('change'));
            }

            // --- Bind Image Controls ---
            if (inputs.imageZoom) inputs.imageZoom.addEventListener('input', updateImageTransform);
            if (inputs.imagePosX) inputs.imagePosX.addEventListener('input', updateImageTransform);
            if (inputs.imagePosY) inputs.imagePosY.addEventListener('input', updateImageTransform);

            if (buttons.resetImage) buttons.resetImage.addEventListener('click', () => {
                if (inputs.imageZoom) inputs.imageZoom.value = 100;
                if (inputs.imagePosX) inputs.imagePosX.value = 50;
                if (inputs.imagePosY) inputs.imagePosY.value = 50;
                updateImageTransform();
                saveDataToLocalStorage(); // Save change
            });

            // --- Bind Image Upload ---
            if (inputs.imageUpload) inputs.imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedImageUrl = event.target.result;
                        outputs.imageArea.innerHTML = '';
                        outputs.imageArea.style.backgroundImage = `url(${uploadedImageUrl})`;
                        imageControls.classList.remove('hidden');
                        buttons.resetImage.click(); // Reset controls to default
                        saveDataToLocalStorage(); // Save change
                    };
                    reader.readAsDataURL(file);
                }
            });

            if (buttons.clearUpload) buttons.clearUpload.addEventListener('click', () => {
                if (inputs.imageUpload) inputs.imageUpload.value = null;
                uploadedImageUrl = null;
                if (outputs.imageArea) {
                    outputs.imageArea.style.backgroundImage = 'none';
                    outputs.imageArea.innerHTML = `<div class="text-center p-4">Upload an image to create your card's art.</div>`;
                }
                if (imageControls) imageControls.classList.add('hidden');
                if (buttons.resetImage) buttons.resetImage.click();
                saveDataToLocalStorage(); // Save change
            });

            // --- Bind Buttons ---
            /* generateImage listener removed */
            if (buttons.downloadCard) buttons.downloadCard.addEventListener('click', downloadCard);
            if (buttons.downloadPrint) buttons.downloadPrint.addEventListener('click', downloadCardForPrint); // NEW
            if (buttons.addAttack) buttons.addAttack.addEventListener('click', () => {
                createAttackForm();
                saveDataToLocalStorage(); // Save change
            });
            if (buttons.exportData) buttons.exportData.addEventListener('click', exportCardData); // NEW
            if (buttons.importData) buttons.importData.addEventListener('change', importCardData); // NEW

            // --- Bind Dark Mode Toggle ---
            if (buttons.darkModeToggle) buttons.darkModeToggle.addEventListener('change', () => {
                document.documentElement.classList.toggle('dark');
                saveDataToLocalStorage(); // Save change
            });

            // --- Energy Modal Logic ---
            const energyModal = document.getElementById('energy-modal');
            const modalTable = document.getElementById('energy-modal-table');
            
            // Populate modal table
            let tableHTML = '';
            for (const [key, icon] of Object.entries(energyIconMap)) {
                const typeName = Object.values(energyTypeMap).find(t => t.icon === icon)?.name || 'N/A';
                tableHTML += `<tr class="border-b dark:border-gray-700"><td class="p-2 font-mono font-bold">${key}</td><td class="p-2 text-2xl">${icon}</td><td class="p-2">${typeName}</td></tr>`;
            }
            if (modalTable) modalTable.innerHTML = tableHTML;

            if (buttons.viewEnergy) buttons.viewEnergy.addEventListener('click', () => energyModal.classList.remove('hidden'));
            if (buttons.closeModal) buttons.closeModal.addEventListener('click', () => energyModal.classList.add('hidden'));
            if (energyModal) energyModal.addEventListener('click', (e) => {
                if (e.target === energyModal) energyModal.classList.add('hidden');
            });
            
            // --- Add Save Listeners to all inputs ---
            Object.values(inputs).forEach(inputEl => {
                if (inputEl) { // <-- ADDED SAFETY CHECK
                    const eventType = (inputEl.type === 'range' || inputEl.type === 'color') ? 'input' : 'change';
                    inputEl.addEventListener(eventType, saveDataToLocalStorage);
                    inputEl.addEventListener('input', saveDataToLocalStorage); // Catch all text/number changes
                }
            });
            
            // --- Initial Setup ---
            // Load data from localStorage *first*
            const dataLoaded = loadDataFromLocalStorage();

            // Add default attacks *only if* no data was loaded
            if (!dataLoaded || (dataLoaded && getCurrentCardData().attacks.length === 0)) {
                createAttackForm({
                    type: 'attack',
                    cost: 'CC',
                    name: 'Data Stream',
                    desc: 'Flip a coin. If heads, draw 3 cards.',
                    damage: '20'
                });
                createAttackForm({
                    type: 'ability',
                    cost: '',
                    name: 'Synaptic Link',
                    desc: 'Once during your turn, you may search your deck for a basic Energy card and attach it to 1 of your PokÃ©mon.',
                    damage: ''
                });
            }
            updateCardAttacks(); // Sync preview
            
            // FIX: Set dark mode by default if no save data
            if (!dataLoaded) {
                document.documentElement.classList.add('dark');
                if (buttons.darkModeToggle) buttons.darkModeToggle.checked = true;
                saveDataToLocalStorage(); // Save this default state
            }
            
            // Set initial style (which is now always full-art)
            if(outputs.card) outputs.card.classList.add('full-art');
            if (outputs.wrrBar) {
                outputs.wrrBar.style.display = 'none';
            }
        });

    </script>
</body>
</html>
