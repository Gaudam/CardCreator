<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Card Creator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Base & Dark Mode --- */
        body {
            font-family: 'Inter', sans-serif;
        }

        .toggle-checkbox:checked {
            @apply: bg-indigo-600;
            right: 0;
        }
        .toggle-checkbox:checked + .toggle-label {
            @apply: bg-indigo-600;
        }
        .toggle-checkbox:checked + .toggle-label .toggle-ball {
            @apply: translate-x-full;
        }

        /* --- Card Typography --- */
        .font-card-title {
            font-family: 'Bebas Neue', cursive; 
            text-shadow: 1px 1px 3px #000, -1px -1px 3px #000, 1px -1px 3px #000, -1px 1px 3px #000;
            font-size: 1.9rem; 
            color: white;
        }
        
        .card-main-name-container {
            position: absolute;
            top: 30px; 
            left: 14px;
            right: 14px;
            z-index: 2;
        }

        .font-creature-type {
            font-family: 'Bebas Neue', cursive; 
            text-shadow: 1px 1px 3px #000, -1px -1px 3px #000, 1px -1px 3px #000, -1px 1px 3px #000;
            font-size: 1.6rem;
            color: white;
            line-height: 1;
        }
        
        /* --- Tier Colors & Styles --- */
        .tier-common { color: #FFFFFF; }
        .tier-uncommon { color: #4CAF50; }
        .tier-rare { color: #00B0FF; }
        .tier-masterwork { color: #FFD700; }
        .tier-epic { color: #9C27B0; }
        .tier-legendary { color: #FF9800; }
        .tier-mythic { color: #800000; }
        
        .tier-unique {
            color: #212121;
            text-shadow: 1px 1px 2px #FFF, -1px -1px 2px #FFF, 1px -1px 2px #FFF, -1px 1px 2px #FFF;
        }

        .tier-exotic {
            color: #FF1493; /* Deep Pink */
            text-shadow: 1px 1px 2px #FFF, -1px -1px 2px #FFF, 1px -1px 2px #FFF, -1px 1px 2px #FFF, 0 0 5px #FFF;
        }
        
        /* --- Card Layout & Structure --- */
        .card {
            width: 100%;
            max-width: 380px;
            aspect-ratio: 63 / 88;
            border: 12px solid #f9d71c;
            border-radius: 18px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #000000; 
            position: relative;
            justify-content: flex-end;
            padding-bottom: 0px;
        }

        /* --- Card Header & Stats (HP/AC) --- */
        .card-header {
            top: 6px; 
            padding: 0 14px 8px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: absolute;
            left: 0;
            right: 0;
            z-index: 2;
            height: 38px;
        }
        
        #card-hp-container, #card-ac-container {
            display: flex;
            align-items: baseline;
            line-height: 1;
        }

        #card-hp-container .font-card-title, #card-ac-container .font-card-title {
            font-size: 1.6rem; 
            margin-left: 2px;
        }
        #card-hp-container .font-creature-type, #card-ac-container .font-creature-type {
            font-size: 1.6rem; 
            margin-right: 2px;
            font-weight: 400;
        }

        /* --- Card Overlays (Gradients) --- */
        .card-top-overlay {
            position: absolute;
            top: -2px; 
            left: -2px;
            right: -2px;
            bottom: -10px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.00) 25%);
            z-index: 1;
            pointer-events: none;
        }
        
        .card-bottom-overlay {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -10px;
            background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.6) 30%, rgba(0,0,0,0.00) 60%);
            z-index: 1;
            pointer-events: none;
        }

        .card-vignette-overlay {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -10px;
            display: none;
            background: linear-gradient(to bottom, 
                rgba(0,0,0,0.7) 0%, 
                rgba(0,0,0,0.1) 30%, 
                rgba(0,0,0,0.00) 70%, 
                rgba(0,0,0,0.1) 90%, 
                rgba(0,0,0,0.7) 100% 
            ),
            linear-gradient(to right,
                rgba(0,0,0,0.7) 0%, 
                rgba(0,0,0,0.1) 30%, 
                rgba(0,0,0,0.00) 50%, 
                rgba(0,0,0,0.1) 70%, 
                rgba(0,0,0,0.7) 100% 
            );
            z-index: 1;
            pointer-events: none;
        }

        /* --- Card Image Area --- */
        .card-image-area {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -10px; 
            margin: 0;
            border: none;
            aspect-ratio: unset;
            z-index: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 600;
            overflow: hidden;
            background: #000000; 
            background-size: 100%;
            background-position: 50% 50%;
            background-repeat: no-repeat;
        }

        .card-image-area img {
            display: none;
        }
        
        /* --- Card Body (Attacks, Flavor) --- */
        .card-stats-bar {
            background: none; 
            border-top: none;
            border-bottom: none; 
            margin: 2px 14px 30px 14px; /* Vertically positioned by bottom margin */
            padding: 0; 
            position: relative; 
            z-index: 2;
            color: #E5E7EB; /* UPDATED: Was white, now light grey */
            font-style: italic;
            text-align: center; /* UPDATED: Was left, now center */
            /* UPDATED for readability */
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            font-size: 0.9rem;
            line-height: 1.3;
            text-shadow: 0px 0px 5px #000, 0px 0px 5px #000;
        }

        .card-attacks {
            flex-grow: 0;
            background: none;
            border: none; 
            margin: 18px 14px 0 14px; 
            padding: 0; 
            position: relative; 
            z-index: 2;
            color: white; 
        }
        
        /* --- ATTACK STYLING --- */
        .attack {
            margin: 0;
            padding: 0;
            border: none;
        }
        /* All divider CSS is removed */
        /* --- END ATTACK STYLING --- */


        .attack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .attack-name {
            /* UPDATED for readability */
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.0rem;
            text-shadow: 0px 0px 5px #000, 0px 0px 5px #000;
        }
        
        .attack-damage {
            /* UPDATED for readability */
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.0rem;
            text-shadow: 0px 0px 5px #000, 0px 0px 5px #000;
        }

        .attack-description {
            /* UPDATED for readability */
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            font-size: 0.9rem;
            line-height: 1.3;
            text-shadow: 0px 0px 5px #000, 0px 0px 5px #000;
        }
        
        .attack-layout {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .attack-details {
            flex-grow: 1;
        }
        
        .card-wrr-bar {
            display: none; /* Hidden in full-art mode */
        }
        
        .wrr-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .wrr-item span:first-child {
            font-size: 0.7rem;
            font-weight: 400;
            color: white;
            text-shadow: 1px 1px 2px #000;
        }

        /* --- Card Footer --- */
        .card-footer {
            /* UPDATED for readability */
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 400; /* CHANGED from 600 */
            line-height: 1.3;
            text-shadow: 0px 0px 5px #000, 0px 0px 5px #000;
            
            padding: 5px 14px 10px 14px; 
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 2;
            background: none; 
            color: white; 
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .card-footer-item {
            line-height: 1.2;
        }
        
        /* --- Utility Classes (Loader, Modal) --- */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #333;
        }
        .dark .modal-content {
            background: #374151;
            color: #f3f4f6;
        }
        .dark .modal-content th {
            color: #f3f4f6;
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-4 md:p-8 transition-colors duration-200">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-center sm:justify-between items-center mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 dark:text-gray-100 mb-4 sm:mb-0">Custom Card Creator</h1>
            
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="dark-mode-toggle" id="dark-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="dark-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-200">Card Details</h2>
                <form id="card-form" class="space-y-4">

                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Basic Info</legend>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2 md:col-span-1">
                                <label for="input-creature-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Creature Type</label>
                                <input type="text" id="input-creature-type" value="Robot" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label for="input-card-tier" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tier</label>
                                <select id="input-card-tier" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option>Common</option>
                                    <option>Uncommon</option>
                                    <option>Rare</option>
                                    <option>Masterwork</option>
                                    <option>Epic</option>
                                    <option>Legendary</option>
                                    <option>Exotic</option>
                                    <option>Mythic</option>
                                    <option>Unique</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label for="input-card-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Card Name</label>
                                <input type="text" id="input-card-name" value="Gemini" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label for="input-card-hp" class="block text-sm font-medium text-gray-700 dark:text-gray-300">HP</label>
                                <input type="number" id="input-card-hp" value="120" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label for="input-card-ac" class="block text-sm font-medium text-gray-700 dark:text-gray-300">AC</label>
                                <input type="number" id="input-card-ac" value="15" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label for="input-border-color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Border Color</label>
                                <input type="color" id="input-border-color" value="#f9d71c" class="mt-1 block w-full h-10 rounded-md border-gray-300 dark:border-gray-600 shadow-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="input-overlay-color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Overlay Color (for gradients)</label>
                                <input type="color" id="input-overlay-color" value="#000000" class="mt-1 block w-full h-10 rounded-md border-gray-300 dark:border-gray-600 shadow-sm">
                            </div>
                            <div class="col-span-2 flex items-center">
                                <input type="checkbox" id="input-vignette-toggle" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                                <label for="input-vignette-toggle" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Apply Rectangular Vignette</label>
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label for="input-set-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Set Name</label>
                                <input type="text" id="input-set-name" value="Galactic Genesis" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label for="input-card-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Card Number (e.g., 15/150)</label>
                                <input type="text" id="input-card-number" value="1/100" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Card Image</legend>
                        <div>
                            <label for="input-image-upload" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Upload Image</label>
                            <input type="file" id="input-image-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 dark:file:bg-indigo-900 file:text-indigo-700 dark:file:text-indigo-300 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-800">
                            <button type="button" id="clear-upload-btn" class="mt-2 w-full text-sm text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300">Clear Upload</button>
                        </div>
                        <div id="image-controls" class="mt-4 border-t dark:border-gray-600 pt-4 space-y-2 hidden">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Image Controls</h4>
                            <div>
                                <label for="image-zoom" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Zoom (<span id="zoom-value">100</span>%)</label>

                                <input type="range" id="image-zoom" min="100" max="3000" value="100" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="image-pos-x" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Horizontal (<span id="pos-x-value">50</span>%)</label>
                                <input type="range" id="image-pos-x" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="image-pos-y" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Vertical (<span id="pos-y-value">50</span>%)</label>
                                <input type="range" id="image-pos-y" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <button type="button" id="reset-image-btn" class="mt-2 w-full text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Reset Position</button>
                        </div>
                    </fieldset>
                    
                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Flavor Text</legend>
                         <div>
                            <textarea id="input-flavor-text" rows="2" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">It constantly processes information from across the web to answer any question.</textarea>
                        </div>
                    </fieldset>

                    <fieldset id="attacks-manager" class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Attacks</legend> <div id="attack-forms-container" class="space-y-4">
                        </div>
                        <button type="button" id="add-attack-btn" class="mt-4 w-full inline-flex justify-center rounded-md border border-dashed border-gray-400 dark:border-gray-500 py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700">
                            + Add Attack
                        </button>
                    </fieldset>
                    
                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Creator</legend>
                        <div class="mt-0">
                            <label for="input-illustrator" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Creator Name</label>
                            <input type="text" id="input-illustrator" value="AI Generated" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                        </div>
                    </fieldset>

                    <fieldset class="border dark:border-gray-600 p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2 text-gray-600 dark:text-gray-300">Import/Export Card</legend>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Save your card data as a .json file to edit later or on another device.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button type="button" id="export-data-btn" class="w-full inline-flex justify-center rounded-md border border-transparent bg-gray-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:ring-offset-gray-800">
                                Export Data (.json)
                            </button>
                            <div>
                                <label for="import-data-btn" class="w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
                                    Import Data (.json)
                                </label>
                                <input type="file" id="import-data-btn" accept=".json,application/json" class="hidden">
                            </div>
                        </div>
                    </fieldset>
                    
                    <button type="button" id="download-btn" class="mt-4 w-full inline-flex justify-center rounded-md border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:ring-offset-gray-800">
                        Download Card (Web PNG)
                    </button>
                    <button type="button" id="download-print-btn" class="mt-2 w-full inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:ring-offset-gray-800">
                        Download for Print (Bleed)
                    </button>
                    <button type="button" id="download-print-with-border-btn" class="mt-2 w-full inline-flex justify-center rounded-md border border-transparent bg-purple-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:ring-offset-gray-800">
                        Download for Print (with Border)
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Use the 'Bleed' button for services that require a 36px bleed, as specified in the PDF.</p>
                </form>
            </div>

            <div class="flex flex-col items-center">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-200 md:hidden">Card Preview</h2>
                
                <div id="card-preview" class="card type-colorless">
                    
                    <div id="card-top-overlay" class="card-top-overlay"></div>
                    <div id="card-vignette-overlay" class="card-vignette-overlay"></div>
                    <div id="card-bottom-overlay" class="card-bottom-overlay"></div> 
                    
                    <div class="card-header">
                        <h3 id="card-creature-type" class="font-creature-type tier-common">Robot</h3>
                        <div class="flex items-center space-x-3">
                            <div id="card-ac-container" class="flex items-center space-x-1">
                                <span class="font-creature-type">AC</span>
                                <span id="card-ac" class="font-card-title ml-1">15</span>
                            </div>
                            <div id="card-hp-container" class="flex items-center space-x-1">
                                <span class="font-creature-type">HP</span>
                                <span id="card-hp" class="font-card-title ml-1">120</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-main-name-container">
                        <h2 id="card-name" class="font-card-title">Gemini</h2>
                    </div>

                    <div class="card-image-area" id="card-image-area">
                        <div class="text-center p-4">
                            Upload an image to create your card's art.
                        </div>
                    </div>
                    
                    <div class="card-attacks" id="card-attacks-output">
                    </div>

                    <div class="card-stats-bar">
                        <span id="card-flavor-text">It constantly processes information from across the web to answer any question.</span>
                    </div>

                    <div id="card-wrr-bar" class="card-wrr-bar">
                    </div>
                    
                    <div class="card-footer">
                        <div class="card-footer-item">
                            Creator: <span id="card-illustrator">AI Generated</span>
                        </div>
                        <div class="card-footer-item text-right">
                            <span id="card-set-name">Galactic Genesis</span>
                            <span id="card-number" class="ml-2">1/100</span> 
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Global State ---
        let uploadedImageUrl = null;
        let attackCounter = 0;

        // --- Element References (filled on DOMContentLoaded) ---
        let inputs, outputs, buttons, imageControls;

        // --- Card Download Functions ---

        /**
         * Downloads the card preview as a standard, high-resolution PNG.
         */
        function downloadCard() {
            const cardElement = document.getElementById('card-preview');
            const downloadBtn = document.getElementById('download-btn');
            
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Preparing...';

            html2canvas(cardElement, {
                useCORS: true, 
                scale: 2, // High-res for web
                backgroundColor: null 
            }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'my-custom-card.png';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(err => {
                console.error("Failed to download card:", err);
            }).finally(() => {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Download Card (Web PNG)';
            });
        }

        /**
         * Downloads a 822x1122 print-ready file with a 36px bleed.
         * This version clips the card's border and uses the border color as the bleed.
         */
        async function downloadCardForPrint() {
            const cardElement = document.getElementById('card-preview');
            const printBtn = document.getElementById('download-print-btn');
    
            printBtn.disabled = true;
            printBtn.textContent = 'Preparing Print File...';

            // 1. Get the computed dimensions of the original element
            const computedStyle = window.getComputedStyle(cardElement);
            
            // 2. Clone the node
            const cardClone = cardElement.cloneNode(true);
            cardClone.id = 'card-preview-clone';
            
            // 3. Style the clone to be off-screen and force its dimensions
            cardClone.style.position = 'absolute';
            cardClone.style.top = '-9999px';
            cardClone.style.left = '0px';
            cardClone.style.width = computedStyle.width;
            cardClone.style.height = computedStyle.height;
            
            // 4. Change the clone's border to transparent (to prevent grey edges on render)
            cardClone.style.borderColor = 'transparent';
            
            // 5. Append clone to the body so html2canvas can see it
            document.body.appendChild(cardClone);

            try {
                // 1. Create the final 822x1122 print canvas
                const printCanvas = document.createElement('canvas');
                printCanvas.width = 822;
                printCanvas.height = 1122;
                const ctx = printCanvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';

                // 2. Fill the ENTIRE canvas with the border color for the bleed
                const borderColor = document.getElementById('input-border-color').value || '#000000';
                ctx.fillStyle = borderColor;
                ctx.fillRect(0, 0, 822, 1122);
                
                // 3. Render the modified clone (with its transparent border)
                const cardCanvas = await html2canvas(cardClone, {
                    useCORS: true,
                    scale: 2, // Render at 2x
                    backgroundColor: null // Transparent background
                });

                // 4. Composite the card on top, but clip the original border
                const borderPx = 12 * 2; // 12px border at 2x scale = 24px
                
                const sx = borderPx; // Source X (skip left border)
                const sy = borderPx; // Source Y (skip top border)
                const sWidth = cardCanvas.width - (borderPx * 2);  // Source Width (clip left/right borders)
                const sHeight = cardCanvas.height - (borderPx * 2); // Source Height (clip top/bottom borders)

                // 5. Draw the *clipped* source onto the destination canvas
                ctx.drawImage(cardCanvas, 
                    sx, sy, sWidth, sHeight,  // Source rect (clipping)
                    36, 36, 750, 1050);       // Destination rect (standard print size inside 36px bleed)

                // 6. Download the final composited image
                const link = document.createElement('a');
                link.href = printCanvas.toDataURL('image/png');
                link.download = 'my-card-PRINT-READY-822x1122.png';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (err) {
                console.error("Failed to download print-ready card:", err);
            } finally {
                // 7. Clean up
                document.body.removeChild(cardClone);
                printBtn.disabled = false;
                printBtn.textContent = 'Download for Print (Bleed)';
            }
        }
        
        /**
         * Downloads a 822x1122 print-ready file *with* the card's border visible.
         * The border color is still used as the 36px bleed around the card.
         */
        async function downloadCardForPrintWithBorder() {
            const cardElement = document.getElementById('card-preview');
            const printBtn = document.getElementById('download-print-with-border-btn');
    
            printBtn.disabled = true;
            printBtn.textContent = 'Preparing Print File...';

            try {
                // 1. Create the final 822x1122 print canvas
                const printCanvas = document.createElement('canvas');
                printCanvas.width = 822;
                printCanvas.height = 1122;
                const ctx = printCanvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';

                // 2. Fill the ENTIRE canvas with the border color for the bleed
                const borderColor = document.getElementById('input-border-color').value || '#000000';
                ctx.fillStyle = borderColor;
                ctx.fillRect(0, 0, 822, 1122);
                
                // 3. Render the original card preview (as-is, with border)
                const cardCanvas = await html2canvas(cardElement, {
                    useCORS: true,
                    scale: 2,
                    backgroundColor: null
                });

                // 4. Composite the card on top, inside the 36px bleed area
                ctx.drawImage(cardCanvas, 36, 36, 750, 1050);

                // 5. Download the final composited image
                const link = document.createElement('a');
                link.href = printCanvas.toDataURL('image/png');
                link.download = 'my-card-PRINT-WITH-BORDER-822x1122.png';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (err) {
                console.error("Failed to download print-ready card (with border):", err);
            } finally {
                printBtn.disabled = false;
                printBtn.textContent = 'Download for Print (with Border)';
            }
        }


        // --- Data Import/Export & LocalStorage ---

        /**
         * Gathers all data from the form into a single object.
         */
        function getCurrentCardData() {
            const inputs = {
                creatureType: document.getElementById('input-creature-type').value,
                cardTier: document.getElementById('input-card-tier').value,
                cardName: document.getElementById('input-card-name').value,
                cardHp: document.getElementById('input-card-hp').value,
                cardAc: document.getElementById('input-card-ac').value,
                borderColor: document.getElementById('input-border-color').value,
                flavorText: document.getElementById('input-flavor-text').value,
                illustrator: document.getElementById('input-illustrator').value,
                overlayColor: document.getElementById('input-overlay-color').value,
                vignetteToggle: document.getElementById('input-vignette-toggle').checked,
                setName: document.getElementById('input-set-name').value,
                cardNumber: document.getElementById('input-card-number').value,
            };

            const imageControls = {
                cardImage: document.getElementById('card-image-area').style.backgroundImage,
                imageZoom: document.getElementById('image-zoom').value,
                imagePosX: document.getElementById('image-pos-x').value,
                imagePosY: document.getElementById('image-pos-y').value
            };

            const attacks = [];
            document.querySelectorAll('#attack-forms-container .attack-form').forEach(form => {
                const formInputs = form.querySelectorAll('input, textarea');
                attacks.push({
                    name: formInputs[0].value,
                    desc: formInputs[1].value,
                    damage: formInputs[2].value
                });
            });

            const theme = {
                darkMode: document.documentElement.classList.contains('dark')
            };

            return { ...inputs, ...imageControls, attacks, theme };
        }

        /**
         * Populates the entire form and preview from a data object.
         */
        function populateForm(data) {
            if (!data) return;

            // Load theme
            if (data.theme?.darkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-mode-toggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('dark-mode-toggle').checked = false;
            }

            // Load simple inputs
            document.getElementById('input-creature-type').value = data.creatureType || 'Robot';
            document.getElementById('input-card-tier').value = data.cardTier || 'Common';
            document.getElementById('input-card-name').value = data.cardName || 'Gemini';
            document.getElementById('input-card-hp').value = data.cardHp ?? '';
            document.getElementById('input-card-ac').value = data.cardAc ?? '';
            document.getElementById('input-border-color').value = data.borderColor || '#f9d71c';
            document.getElementById('input-flavor-text').value = data.flavorText || '';
            document.getElementById('input-illustrator').value = data.illustrator || 'AI Generated';
            document.getElementById('input-overlay-color').value = data.overlayColor || '#000000';
            document.getElementById('input-vignette-toggle').checked = data.vignetteToggle || false;
            document.getElementById('input-set-name').value = data.setName || 'Set Name';
            document.getElementById('input-card-number').value = data.cardNumber || '1/100';

            // Load image
            const imageArea = document.getElementById('card-image-area');
            if (data.cardImage && data.cardImage !== 'none') {
                imageArea.style.backgroundImage = data.cardImage;
                imageArea.innerHTML = ''; // Clear placeholder
                document.getElementById('image-controls').classList.remove('hidden');
                document.getElementById('image-zoom').value = data.imageZoom || 100;
                document.getElementById('image-pos-x').value = data.imagePosX || 50;
                document.getElementById('image-pos-y').value = data.imagePosY || 50;
                uploadedImageUrl = data.cardImage.includes("data:image") ? data.cardImage.match(/url\("?(.+?)"?\)/)[1] : null;
            } else {
                // Clear image
                imageArea.style.backgroundImage = 'none';
                imageArea.innerHTML = `<div class="text-center p-4">Upload an image to create your card's art.</div>`;
                document.getElementById('image-controls').classList.add('hidden');
                uploadedImageUrl = null;
            }

            // Load attacks
            document.getElementById('attack-forms-container').innerHTML = ''; // Clear existing
            if (data.attacks && data.attacks.length > 0) {
                data.attacks.forEach(attackData => createAttackForm(attackData));
            }

            // Trigger all update functions to sync preview
            document.getElementById('input-creature-type').dispatchEvent(new Event('input'));
            document.getElementById('input-card-tier').dispatchEvent(new Event('change'));
            document.getElementById('input-card-name').dispatchEvent(new Event('input'));
            document.getElementById('input-card-hp').dispatchEvent(new Event('input'));
            document.getElementById('input-card-ac').dispatchEvent(new Event('input'));
            document.getElementById('input-border-color').dispatchEvent(new Event('input'));
            document.getElementById('input-flavor-text').dispatchEvent(new Event('input'));
            document.getElementById('input-illustrator').dispatchEvent(new Event('input'));
            document.getElementById('input-overlay-color').dispatchEvent(new Event('input'));
            document.getElementById('input-vignette-toggle').dispatchEvent(new Event('change'));
            document.getElementById('input-set-name').dispatchEvent(new Event('input'));
            document.getElementById('input-card-number').dispatchEvent(new Event('input'));
            
            updateImageTransform();
            updateCardAttacks();
            updateCardTier();
        }

        /**
         * Saves the current card data to localStorage.
         */
        function saveDataToLocalStorage() {
            try {
                const data = getCurrentCardData();
                localStorage.setItem('customCardData', JSON.stringify(data));
            } catch (error) {
                console.error("Failed to save data to localStorage:", error);
            }
        }

        /**
         * Loads card data from localStorage on page load.
         */
        function loadDataFromLocalStorage() {
            const dataString = localStorage.getItem('customCardData');
            if (dataString) {
                try {
                    const data = JSON.parse(dataString);
                    populateForm(data);
                    return true; // Data was loaded
                } catch (error) {
                    console.error("Failed to parse data from localStorage:", error);
                    localStorage.removeItem('customCardData'); // Clear bad data
                    return false;
                }
            }
            return false; // No data found
        }

        /**
         * Exports the current card data as a .json file.
         */
        function exportCardData() {
            const data = getCurrentCardData();
            const jsonString = JSON.stringify(data, null, 2); // Pretty-print JSON
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${data.cardName || 'custom-card'}-data.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * Handles the file upload for importing card data.
         */
        function importCardData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    populateForm(data);
                    saveDataToLocalStorage(); // Save imported data
                } catch (error) {
                    console.error("Failed to import card data:", error);
                }
            };
            reader.readAsText(file);
            
            event.target.value = null;
        }

        // --- Dynamic Attack Form Management ---

        /**
         * Creates a new attack form and adds it to the DOM.
         */
        function createAttackForm(defaultValues = {}) {
            attackCounter++;
            const id = attackCounter;
            
            const {
                name = 'New Attack',
                desc = 'Attack description.',
                damage = '10'
            } = defaultValues;

            const formContainer = document.getElementById('attack-forms-container');
            const attackForm = document.createElement('div');
            attackForm.className = 'attack-form border dark:border-gray-600 p-3 rounded-md bg-gray-50 dark:bg-gray-700 space-y-2 relative';
            attackForm.dataset.id = id;

            attackForm.innerHTML = `
                <button type="button" class="delete-attack-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">&times;</button>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" value="${name}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea rows="2" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">${desc}</textarea>
                </div>
                <div class="attack-damage-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Damage</label>
                    <input type="text" value="${damage}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm sm:text-sm">
                </div>
            `;

            formContainer.appendChild(attackForm);

            // Add event listeners
            attackForm.querySelector('.delete-attack-btn').addEventListener('click', () => {
                attackForm.remove();
                updateCardAttacks();
                saveDataToLocalStorage();
            });
            
            // Add listeners to all inputs to update preview
            attackForm.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', () => {
                    updateCardAttacks();
                    saveDataToLocalStorage();
                });
            });
        }


        // --- Card Preview Update Functions ---

        /**
         * Reads all attack forms and updates the card preview.
         */
        function updateCardAttacks() {
            const forms = document.querySelectorAll('#attack-forms-container .attack-form');
            const outputContainer = document.getElementById('card-attacks-output');
            if (!outputContainer) return;
            outputContainer.innerHTML = '';

            forms.forEach((form, index) => {
                const inputs = form.querySelectorAll('input, textarea');
                const name = inputs[0].value;
                const desc = inputs[1].value;
                const damage = inputs[2].value;

                // --- MODIFICATION: REMOVED DIVIDER ---
                // The divider element has been completely removed.
                // --- END MODIFICATION ---

                const attackEl = document.createElement('div');
                attackEl.className = 'attack';

                // --- NEW MODIFICATION: Add space between attacks ---
                if (index > 0) {
                    // Add a clean 8px space above attacks (but not the first one)
                    attackEl.style.marginTop = '8px'; 
                }
                // --- END NEW MODIFICATION ---

                attackEl.innerHTML = `
                    <div class="attack-layout">
                        <div class="attack-details"> 
                            <div class="attack-header">
                                <span class="attack-name">${name}</span>
                                <span class="attack-damage">${damage}</span>
                            </div>
                            <p class="attack-description">
                                ${desc.replace(/\n/g, '<br>')}
                            </p>
                        </div>
                    </div>
                `;
                
                outputContainer.appendChild(attackEl); // Append the attack
            });
        }
        
        /**
         * Updates the card image's zoom and position.
         */
        function updateImageTransform() {
            if (!inputs.imageZoom || !inputs.imagePosX || !inputs.imagePosY || !outputs.imageArea || !outputs.zoomValue || !outputs.posXValue || !outputs.posYValue) return;
            const zoom = inputs.imageZoom.value;
            const posX = inputs.imagePosX.value;
            const posY = inputs.imagePosY.value;

            outputs.imageArea.style.backgroundSize = `${zoom}%`;
            outputs.imageArea.style.backgroundPosition = `${posX}% ${posY}%`;
            
            outputs.zoomValue.textContent = zoom;
            outputs.posXValue.textContent = posX;
            outputs.posYValue.textContent = posY;
        }

        /**
         * Updates the card's creature type color based on the selected tier.
         */
        function updateCardTier() {
            const inputCardTier = document.getElementById('input-card-tier');
            const creatureTypeOutput = document.getElementById('card-creature-type');

            if (!inputCardTier || !creatureTypeOutput) return;
            const tier = inputCardTier.value.toLowerCase();
            
            // Remove all existing tier classes
            creatureTypeOutput.classList.remove(
                'tier-common', 'tier-uncommon', 'tier-rare', 'tier-masterwork',
                'tier-epic', 'tier-legendary', 'tier-exotic', 'tier-mythic', 'tier-unique'
            );

            // Add the new class
            if (tier) {
                creatureTypeOutput.classList.add(`tier-${tier}`);
            }
        }
        
        // --- Main Initialization (DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 1. Get Element References ---
            inputs = {
                creatureType: document.getElementById('input-creature-type'), 
                inputCardTier: document.getElementById('input-card-tier'),
                cardName: document.getElementById('input-card-name'),
                cardHp: document.getElementById('input-card-hp'),
                cardAc: document.getElementById('input-card-ac'),
                borderColor: document.getElementById('input-border-color'),
                imageUpload: document.getElementById('input-image-upload'),
                flavorText: document.getElementById('input-flavor-text'),
                illustrator: document.getElementById('input-illustrator'),
                overlayColor: document.getElementById('input-overlay-color'), 
                vignetteToggle: document.getElementById('input-vignette-toggle'), 
                setName: document.getElementById('input-set-name'), 
                cardNumber: document.getElementById('input-card-number'), 
                imageZoom: document.getElementById('image-zoom'),
                imagePosX: document.getElementById('image-pos-x'),
                imagePosY: document.getElementById('image-pos-y'),
            };

            outputs = {
                card: document.getElementById('card-preview'),
                creatureType: document.getElementById('card-creature-type'), 
                cardName: document.getElementById('card-name'),
                cardHp: document.getElementById('card-hp'),
                cardHpContainer: document.getElementById('card-hp-container'),
                cardAc: document.getElementById('card-ac'),
                cardAcContainer: document.getElementById('card-ac-container'),
                imageArea: document.getElementById('card-image-area'),
                flavorText: document.getElementById('card-flavor-text'),
                attacks: document.getElementById('card-attacks-output'),
                illustrator: document.getElementById('card-illustrator'),
                wrrBar: document.getElementById('card-wrr-bar'), 
                cardTopOverlay: document.getElementById('card-top-overlay'), 
                cardVignetteOverlay: document.getElementById('card-vignette-overlay'), 
                setName: document.getElementById('card-set-name'), 
                cardNumber: document.getElementById('card-number'), 
                zoomValue: document.getElementById('zoom-value'),
                posXValue: document.getElementById('pos-x-value'),
                posYValue: document.getElementById('pos-y-value'),
            };

            buttons = {
                downloadCard: document.getElementById('download-btn'),
                downloadPrint: document.getElementById('download-print-btn'),
                downloadPrintWithBorder: document.getElementById('download-print-with-border-btn'),
                clearUpload: document.getElementById('clear-upload-btn'),
                addAttack: document.getElementById('add-attack-btn'),
                resetImage: document.getElementById('reset-image-btn'),
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                exportData: document.getElementById('export-data-btn'),
                importData: document.getElementById('import-data-btn')
            };
            
            imageControls = document.getElementById('image-controls');

            // --- 2. Define Helper Functions ---
            
            /**
             * Binds an input element's value to an output element's text content.
             */
            function bindText(inputEl, outputEl, parserFn = null) {
                if (!inputEl || !outputEl) {
                    console.warn("bindText: Missing input or output element.", inputEl, outputEl);
                    return;
                }
                const update = () => {
                    outputEl[parserFn ? 'innerHTML' : 'textContent'] = parserFn 
                        ? parserFn(inputEl.value) 
                        : inputEl.value;
                };
                inputEl.addEventListener('input', update);
                update(); // Initial sync
            }
            
            // --- 3. Bind UI Elements ---
            
            // Bind Simple Text Fields
            bindText(inputs.creatureType, outputs.creatureType); 
            bindText(inputs.cardName, outputs.cardName);
            bindText(inputs.flavorText, outputs.flavorText);
            bindText(inputs.illustrator, outputs.illustrator);
            bindText(inputs.setName, outputs.setName); 
            bindText(inputs.cardNumber, outputs.cardNumber); 
            
            // Bind HP and AC with visibility toggle
            const updateHp = () => {
                if (!inputs.cardHp || !outputs.cardHp || !outputs.cardHpContainer) return;
                const value = inputs.cardHp.value;
                outputs.cardHp.textContent = value;
                outputs.cardHpContainer.style.display = value ? 'flex' : 'none';
            };
            if(inputs.cardHp) inputs.cardHp.addEventListener('input', updateHp);
            updateHp(); // Initial sync

            const updateAc = () => {
                if (!inputs.cardAc || !outputs.cardAc || !outputs.cardAcContainer) return;
                const value = inputs.cardAc.value;
                outputs.cardAc.textContent = value;
                outputs.cardAcContainer.style.display = value ? 'flex' : 'none';
            };
            if(inputs.cardAc) inputs.cardAc.addEventListener('input', updateAc);
            updateAc(); // Initial sync
            
            // Bind Border Color
            if (inputs.borderColor && outputs.card) {
                inputs.borderColor.addEventListener('input', () => {
                    outputs.card.style.borderColor = inputs.borderColor.value;
                });
                inputs.borderColor.dispatchEvent(new Event('input')); // Initial sync
            }

            // Bind Overlay Color
            function hexToRgba(hex, alpha) {
                if (!hex || hex.length < 7) hex = '#000000'; // Fallback for invalid hex
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                const a = alpha === 0 ? 0.01 : alpha; // Use 0.01 for transparent end
                return `rgba(${r}, ${g}, ${b}, ${a})`;
            }

            if (inputs.overlayColor) {
                inputs.overlayColor.addEventListener('input', () => {
                    const color = inputs.overlayColor.value;
                    if (outputs.cardTopOverlay) outputs.cardTopOverlay.style.background = `linear-gradient(to bottom, ${hexToRgba(color, 0.8)} 0%, ${hexToRgba(color, 0.01)} 25%)`;
                    
                    // Update bottom overlay color as well
                    const bottomOverlay = document.getElementById('card-bottom-overlay');
                    if (bottomOverlay) bottomOverlay.style.background = `linear-gradient(to top, ${hexToRgba(color, 0.85)} 0%, ${hexToRgba(color, 0.6)} 30%, ${hexToRgba(color, 0.01)} 60%)`;

                    if (outputs.cardVignetteOverlay) outputs.cardVignetteOverlay.style.background = `
                        linear-gradient(to bottom, 
                            ${hexToRgba(color, 0.7)} 0%, 
                            ${hexToRgba(color, 0.1)} 30%, 
                            ${hexToRgba(color, 0.01)} 70%, 
                            ${hexToRgba(color, 0.1)} 90%, 
                            ${hexToRgba(color, 0.7)} 100%
                        ),
                        linear-gradient(to right,
                            ${hexToRgba(color, 0.7)} 0%, 
                            ${hexToRgba(color, 0.1)} 30%, 
                            ${hexToRgba(color, 0.01)} 50%, 
                            ${hexToRgba(color, 0.1)} 70%, 
                            ${hexToRgba(color, 0.7)} 100%
                        )
                    `;
                });
                inputs.overlayColor.dispatchEvent(new Event('input')); // Initial sync
            }

            // Bind Vignette Toggle
            if (inputs.vignetteToggle) {
                inputs.vignetteToggle.addEventListener('change', () => {
                    const bottomOverlay = document.getElementById('card-bottom-overlay');
                    if (inputs.vignetteToggle.checked) {
                        if (outputs.cardVignetteOverlay) outputs.cardVignetteOverlay.style.display = 'block';
                        if (outputs.cardTopOverlay) outputs.cardTopOverlay.style.display = 'none';
                        if (bottomOverlay) bottomOverlay.style.display = 'none'; // Hide new bottom overlay if vignette is on
                    } else {
                        if (outputs.cardVignetteOverlay) outputs.cardVignetteOverlay.style.display = 'none';
                        if (outputs.cardTopOverlay) outputs.cardTopOverlay.style.display = 'block';
                        if (bottomOverlay) bottomOverlay.style.display = 'block'; // Show new bottom overlay
                    }
                });
                inputs.vignetteToggle.dispatchEvent(new Event('change'));
            }

            // Bind Tier Dropdown
            if (inputs.inputCardTier) {
                inputs.inputCardTier.addEventListener('change', () => {
                    updateCardTier();
                    saveDataToLocalStorage();
                });
            }

            // Bind Image Controls
            if (inputs.imageZoom) inputs.imageZoom.addEventListener('input', updateImageTransform);
            if (inputs.imagePosX) inputs.imagePosX.addEventListener('input', updateImageTransform);
            if (inputs.imagePosY) inputs.imagePosY.addEventListener('input', updateImageTransform);

            if (buttons.resetImage) buttons.resetImage.addEventListener('click', () => {
                if (inputs.imageZoom) inputs.imageZoom.value = 100;
                if (inputs.imagePosX) inputs.imagePosX.value = 50;
                if (inputs.imagePosY) inputs.imagePosY.value = 50;
                updateImageTransform();
                saveDataToLocalStorage();
            });

            // Bind Image Upload
            if (inputs.imageUpload) inputs.imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedImageUrl = event.target.result;
                        outputs.imageArea.innerHTML = '';
                        outputs.imageArea.style.backgroundImage = `url(${uploadedImageUrl})`;
                        imageControls.classList.remove('hidden');
                        buttons.resetImage.click(); // Reset controls to default
                        saveDataToLocalStorage();
                    };
                    reader.readAsDataURL(file);
                }
            });

            if (buttons.clearUpload) buttons.clearUpload.addEventListener('click', () => {
                if (inputs.imageUpload) inputs.imageUpload.value = null;
                uploadedImageUrl = null;
                if (outputs.imageArea) {
                    outputs.imageArea.style.backgroundImage = 'none';
                    outputs.imageArea.innerHTML = `<div class="text-center p-4">Upload an image to create your card's art.</div>`;
                }
                if (imageControls) imageControls.classList.add('hidden');
                if (buttons.resetImage) buttons.resetImage.click();
                saveDataToLocalStorage();
            });

            // --- 4. Bind Button Listeners ---
            if (buttons.downloadCard) buttons.downloadCard.addEventListener('click', downloadCard);
            if (buttons.downloadPrint) buttons.downloadPrint.addEventListener('click', downloadCardForPrint);
            if (buttons.downloadPrintWithBorder) buttons.downloadPrintWithBorder.addEventListener('click', downloadCardForPrintWithBorder);
            if (buttons.addAttack) buttons.addAttack.addEventListener('click', () => {
                createAttackForm();
                saveDataToLocalStorage();
            });
            if (buttons.exportData) buttons.exportData.addEventListener('click', exportCardData);
            if (buttons.importData) buttons.importData.addEventListener('change', importCardData);

            // Bind Dark Mode Toggle
            if (buttons.darkModeToggle) buttons.darkModeToggle.addEventListener('change', () => {
                document.documentElement.classList.toggle('dark');
                saveDataToLocalStorage();
            });

            // Add auto-save listeners to all form inputs
            Object.values(inputs).forEach(inputEl => {
                if (inputEl) {
                    const eventType = (inputEl.type === 'range' || inputEl.type === 'color') ? 'input' : 'change';
                    inputEl.addEventListener(eventType, saveDataToLocalStorage);
                    inputEl.addEventListener('input', saveDataToLocalStorage); // Catch all text/number changes
                }
            });
            
            // --- 5. Initial Page Setup ---
            
            // Load data from localStorage first
            const dataLoaded = loadDataFromLocalStorage();

            // Add default attacks only if no data was loaded or attacks are empty
            if (!dataLoaded || (dataLoaded && getCurrentCardData().attacks.length === 0)) {
                createAttackForm({
                    name: 'Data Stream',
                    desc: 'Flip a coin. If heads, draw 3 cards.',
                    damage: '20'
                });
            }
            updateCardAttacks();
            updateCardTier();
            
            // Default to dark mode if no save data exists
            if (!dataLoaded) {
                document.documentElement.classList.add('dark');
                if (buttons.darkModeToggle) buttons.darkModeToggle.checked = true;
                saveDataToLocalStorage();
            }
            
            // Set initial card style (always full-art)
            if(outputs.card) outputs.card.classList.add('full-art');
            if (outputs.wrrBar) {
                outputs.wrrBar.style.display = 'none';
            }
        });

    </script>
</body>
</html>
